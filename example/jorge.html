<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no"/>
    <title>Elecciones</title>
    <link rel="stylesheet" href="https://js.arcgis.com/4.11/esri/themes/light/main.css"/>
    <link rel="stylesheet" href="https://js.arcgis.com/4.11/dijit/themes/claro/claro.css"/>

    <style>
      html,
      body,
      #viewDiv {
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
        overflow: hidden;
        font-family: "Avenir Next W00", "Helvetica Neue", Helvetica, Arial,
          sans-serif;
      }

      #chartPanel {
        background: rgba(255,255,255,0.3);
        font: "Avenir Next W00";
        line-height: 1.5em;
        overflow: auto;
        padding: 10px;
        width: 300px;
        height: 300px;
        display: block;
      }

      .chart {
        height: 280px;
      }

    </style>

    <!-- Load the Chart.js library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.4.0/Chart.min.js"></script>
    <script src="https://js.arcgis.com/4.11/"></script>

    <script>
      require([
        "esri/Map",
        "esri/views/MapView",
        "esri/geometry/geometryEngine",
        "esri/widgets/Expand",
        "esri/layers/StreamLayer"
      ], function(Map,MapView,geometryEngine,Expand,StreamLayer){
        window.app = init(Map,MapView,geometryEngine,Expand,StreamLayer);
      });

      function init(Map,MapView,geometryEngine,Expand,StreamLayer) {
        // App 'globals'
        let chartExpand;

        const streamLayer = new StreamLayer({
          url: "http://localhost:9000/arcgis/rest/services/twitter/StreamServer",
          purgeOptions: {
            displayCount: 10000
          },
          featureReduction: {
            type: "selection"
          },
          popupTemplate : {
            title : "Tweet from {screename}",
            content : function(target) {
              return tweetContent(target.graphic.attributes);
            }
          },
          outFields : ["*"]
        });

        // Create map
        const map = new Map({
          basemap: "dark-gray",
          layers: [streamLayer]
        });

        // Create view
        const view = new MapView({
          container: "viewDiv",
          map: map,
          zoom: 6,
          center: [-4.033410164417723, 40.62277993555629],
          highlightOptions: {
            color: [255, 255, 0, 1],
            haloOpacity: 0.9,
            fillOpacity: 1
          }
        });

        var counter = {
          pp : new Set(),
          psoe: new Set(),
          ciudadanos : new Set() ,
          vox : new Set(),
          podemos: new Set()
        };

        var partidos = [
          "pp",
          "psoe",
          "ciudadanos",
          "podemos",
          "vox"
        ];

        window.counter = counter;

        window.setInterval(function(){
          updateChart([
            window.counter.pp.size,
            window.counter.psoe.size,
            window.counter.ciudadanos.size,
            window.counter.podemos.size,
            window.counter.vox.size,
          ]);
        }, 1000);


        function tweetContent(obj){

          let markText = obj.text;
          if(obj.markWords.length > 0){
            let reMarks = new RegExp(`(${obj.markWords.join("|")})`,"ig");
            markText = obj.text.replace(reMarks, `<mark>$1</mark>`, "g");
          }

          return `<div>
            <img src="${obj.profile_image_url_https}" />
            <p>${markText}</p>
            <a href="${obj.tweet_url}" target="_blank">Tweet</a>
            <ul>
              ${partidos.map(el => `<li>${el} : ${obj[el]}</li>`).join("")}
            </ul>
          </div>`
        }


        var highlight;

        function highlightFeatures(property){

          let query = {
            where : `${property} = true`
          };
          view.layerViews.items[0].queryFeatures(query).then(function(results){
            if (highlight) {
              highlight.remove();
            }
            if (results.features.length > 0) {
              highlight = view.layerViews.items[0].highlight(results.features.map(el => el.attributes["__OBJECTID"]));
            }
          })
          .catch(function(err) {
            console.log(err);
          });
        }

        setUpAppUI();

        function setUpAppUI() {
          view.whenLayerView(streamLayer).then(function(layerView){

            layerView.watch("updating", function(val){
              if(!val){  // wait for the layer view to finish updating
                layerView.queryFeatures().then(function(results){
                  if (results.features.length > 0) {
                   results.features
                    .filter(el => el.attributes.markWords.length > 0)
                    .map(el => ({
                        id : el.attributes.id_str,
                        pp : el.attributes.pp,
                        vox : el.attributes.vox,
                        ciudadanos : el.attributes.ciudadanos,
                        psoe : el.attributes.psoe,
                        podemos : el.attributes.psoe,
                        markWords : el.attributes.markWords
                      }))
                    .reduce((old,cur,i,arr) => {

                        Object.keys(cur).forEach(k => {
                          if (cur[k] === true) {
                            window.counter[k].add(cur.id)
                          }
                        });
                        return old;
                    }, window.counter)

                  }

                });
              }
            });
          });

          view.when(function() {

            // Display the chart in an Expand widget
            chartExpand = new Expand({
              expandIconClass: "esri-icon-chart",
              expandTooltip: "Partidos PolÃ­ticos",
              expanded: false,
              view: view,
              content: document.getElementById("chartPanel")
            });

            view.ui.add(chartExpand, "top-right");
          });

        }


        // Create an population pyramid chart for the census tracts that intersect the buffer polygon
        // Chart is created using the Chart.js library
        const canvasElement = document.getElementById("chart");
        var chart = new Chart(canvasElement.getContext("2d"), {
          type: 'pie',
          data: {
            datasets: [{
                data : [0,0,0,0,0],
                backgroundColor : ["#2196f3","#f44336","#ea8a0b","#9c27b0","#8bc34a"],
                label : "Tweets"
            }],
            labels : partidos
          },
          options : {
            responsive : true,
            // tooltips : {
            //   callbacks: {
            //     label : function(tooltipItem, data){
            //       console.log(data[tooltipItem.datasetIndex]);
            //     }
            //   }
            // },
            legend : {
              display: false
            },
            title: {
              display: true,
              text: 'Tweets'
            },
            onClick : function(event,arr){
              highlightFeatures(partidos[arr[0]._index]);
            }
          }
        });

        function updateChart(arr) {

          let total = arr.reduce((old,cur) => old+cur,0)
          chart.data.datasets[0].data = arr;
          chart.options.title.text = `Tweets [${total}]`;
          chart.update();
          //console.log(`Updated : ${chart.data.datasets[0].data}`);
        }

        return {
          map : map,
          view: view,
          widget : chartExpand,
          streamLayer : streamLayer
        }
      };

    </script>
  </head>

  <body>
    <div id="viewDiv"></div>
    <div id="chartPanel"><canvas id="chart" class="chart"></canvas></div>
  </body>
</html>
