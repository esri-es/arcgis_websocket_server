<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no"/>
    <title>Elecciones</title>
    <link rel="stylesheet" href="https://js.arcgis.com/4.11/esri/themes/light/main.css"/>
    <link rel="stylesheet" href="https://js.arcgis.com/4.11/dijit/themes/claro/claro.css"/>

    <style>
      html,
      body,
      #viewDiv {
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
        overflow: hidden;
        font-family: "Avenir Next W00", "Helvetica Neue", Helvetica, Arial,
          sans-serif;
      }

      #chartPanel {
        background: rgba(255,255,255,0.3);
        font: "Avenir Next W00";
        line-height: 1.5em;
        overflow: auto;
        padding: 10px;
        width: 300px;
        height: 300px;
        display: block;
      }

      .chart {
        height: 280px;
      }

    </style>

    <!-- Load the Chart.js library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.4.0/Chart.min.js"></script>
    <script src="https://js.arcgis.com/4.11/"></script>

    <script>
      require([
        "esri/Map",
        "esri/views/MapView",
        "esri/geometry/geometryEngine",
        "esri/widgets/Expand",
        "esri/layers/StreamLayer"
      ], function(Map,MapView,geometryEngine,Expand,StreamLayer){
        window.app = init(Map,MapView,geometryEngine,Expand,StreamLayer);
      });

      function init(Map,MapView,geometryEngine,Expand,StreamLayer) {
        // App 'globals'
        let chartExpand;

        const streamLayer = new StreamLayer({
          url: "http://localhost:9000/arcgis/rest/services/twitter/StreamServer",
          purgeOptions: {
            displayCount: 10000
          },
          featureReduction: {
            type: "selection"
          },
          popupTemplate : {
            title : "Tweet from {screename}",
            content : function(target) {
              return tweetContent(target.graphic.attributes);
            }
          },
          outFields : ["*"]
        });

        // Create map
        const map = new Map({
          basemap: "dark-gray",
          layers: [streamLayer]
        });

        // Create view
        const view = new MapView({
          container: "viewDiv",
          map: map,
          zoom: 6,
          center: [-4.033410164417723, 40.62277993555629],
          highlightOptions: {
            color: [255, 255, 0, 1],
            haloOpacity: 0.9,
            fillOpacity: 1
          }
        });

        var counter = {
          pp : new Set(),
          psoe: new Set(),
          ciudadanos : new Set() ,
          vox : new Set(),
          podemos: new Set()
        };

        var partidos = [
          "pp",
          "psoe",
          "ciudadanos",
          "podemos",
          "vox"
        ];

        window.counter = counter;

        window.setInterval(function(){
          console.dir(window.counter);
          updateChart([
            window.counter.pp.size,
            window.counter.psoe.size,
            window.counter.ciudadanos.size,
            window.counter.podemos.size,
            window.counter.vox.size,
          ]);
        }, 1500);



        function tweetContent(obj){
          let markText = obj.text;
          if(obj.markWords.length > 0){
            let reMarks = new RegExp(`(${obj.markWords.join("|")})`,"ig");
            markText = obj.text.replace(reMarks, `<mark>$1</mark>`, "gi");
          }

          return `<div>
            <img src="${obj.profile_image_url_https}" />
            <p>${obj.markWords.join(",")}</p>
            <p>${obj.lon},${obj.lat}</p>
            <p><b>Match:</b>${obj.match}</p>
            <p><b>Location:</b>${obj.location}</p>
            <p>${markText}</p>
            <a href="${obj.tweet_url}" target="_blank">Tweet</a>
            <ul>
              ${partidos.map(el => `<li>${el} : ${obj[el]}</li>`).join("")}
            </ul>
          </div>`
        }


        var highlight;

        function highlightFeatures(property){

          let query = {
            where : `${property} = true`
          };
          console.log(`querying [${property}]`);
          view.layerViews.items[0].queryFeatures(query).then(function(results){
            if (highlight) {
              highlight.remove();
            }
            if (results.features.length > 0) {
              highlight = view.layerViews.items[0].highlight(results.features.map(el => el.attributes["__OBJECTID"]));
            }
          })
          .catch(function(err) {
            console.log(err);
          });
        }

        setUpAppUI();

        var watchHandle;

        function setupWatching(lView,counter) {
          if (watchHandle) {
            watchHandle.remove();
          }
          watchHandle = lView.watch("updating", function(val){
            if(!val){  // wait for the layer view to finish updating
              lView.queryFeatures().then(function(results){
                if (results.features.length > 0) {
                 results.features
                  .filter(el => el.attributes.markWords.length > 0)
                  .map(el => ({
                      id : el.attributes.id_str,
                      pp : el.attributes.pp,
                      vox : el.attributes.vox,
                      ciudadanos : el.attributes.ciudadanos,
                      psoe : el.attributes.psoe,
                      podemos : el.attributes.podemos
                    }))
                  .reduce((old,cur,i,arr) => {
                      let {id, ...partidos} = cur;
                      Object.keys(partidos).forEach(k => {
                        if (cur[k] === true ) {
                          window.counter[k].add(cur.id)
                        }
                      });
                      return old;
                  }, counter)

                }

              });
            }
          });
        }

        function setUpAppUI() {
          view.whenLayerView(streamLayer).then(function(layerView){

            setupWatching(layerView);

        });


          view.when(function() {

            var filterSelect = document.createElement("select");

            // Todo : Build a list with filters
            var fieldList = streamLayer.fields.map(el => ({name : el.name, type : el.type}) )
            console.table(fieldList);

            var filterBtn = document.createElement('button');
            filterBtn.addEventListener("click", btnFn);
            filterBtn.innerHTML = "Filtrar";

            function btnFn(evt){
              window.app.streamLayer.definitionExpression = "pp = 'true'";
              window.app.reset();
            }


            // Display the chart in an Expand widget
            chartExpand = new Expand({
              expandIconClass: "esri-icon-chart",
              expandTooltip: "Partidos PolÃ­ticos",
              expanded: false,
              view: view,
              content: document.getElementById("chartPanel")
            });

            view.ui.add(filterBtn, "bottom-left");
            view.ui.add(chartExpand, "top-right");
          });

        }

        const canvasElement = document.getElementById("chart");
        var chart = new Chart(canvasElement.getContext("2d"), {
          type: 'pie',
          data: {
            datasets: [{
                data : [0,0,0,0,0],
                backgroundColor : ["#2196f3","#f44336","#ea8a0b","#9c27b0","#8bc34a"],
                label : "Tweets"
            }],
            labels : partidos
          },
          options : {
            responsive : true,
            legend : {
              display: false
            },
            title: {
              display: true,
              text: 'Tweets'
            },
            onClick : function(event,arr){
              highlightFeatures(partidos[arr[0]._index]);
            }
          }
        });

        function updateChart(arr) {
          let total = arr.reduce((old,cur) => old+cur,0)
          chart.data.datasets[0].data = arr;
          chart.options.title.text = `Tweets [${total}]`;
          chart.update();
        }

        return {
          map : map,
          view: view,
          widget : chartExpand,
          streamLayer : streamLayer,
          reset : function(){
            updateChart([0,0,0,0,0]);
            window.counter =  {
              pp : new Set(),
              psoe: new Set(),
              ciudadanos : new Set() ,
              vox : new Set(),
              podemos: new Set()
            };
            setupWatching(view.layerViews.items[0], window.counter);

          }

        }
      };

    </script>
  </head>

  <body>
    <div id="viewDiv"></div>
    <div id="chartPanel"><canvas id="chart" class="chart"></canvas></div>
  </body>
</html>
